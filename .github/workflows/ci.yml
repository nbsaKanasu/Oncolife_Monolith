# =============================================================================
# OncoLife Monolith - Continuous Integration (CI) Workflow
# =============================================================================
# Runs on every pull request and push to main branch
# 
# Jobs:
# 1. Lint - Check code quality (Python + TypeScript)
# 2. Test - Run unit tests for all services
# 3. Build - Build Docker images (validates Dockerfiles)
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # LINT JOB - Code Quality Checks
  # ===========================================================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Python Linting
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python linters
        run: |
          pip install ruff black isort

      - name: Run ruff (Python linter)
        run: |
          ruff check apps/patient-platform/patient-api/src --ignore E501
          ruff check apps/doctor-platform/doctor-api/src --ignore E501

      - name: Check Python formatting with black
        run: |
          black --check apps/patient-platform/patient-api/src || true
          black --check apps/doctor-platform/doctor-api/src || true

      # TypeScript/JavaScript Linting
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Node dependencies (Patient Web)
        working-directory: apps/patient-platform/patient-web
        run: npm ci --legacy-peer-deps

      - name: Run ESLint (Patient Web)
        working-directory: apps/patient-platform/patient-web
        run: npm run lint || true

      - name: Install Node dependencies (Doctor Web)
        working-directory: apps/doctor-platform/doctor-web
        run: npm ci --legacy-peer-deps

      - name: Run ESLint (Doctor Web)
        working-directory: apps/doctor-platform/doctor-web
        run: npm run lint || true

  # ===========================================================================
  # TEST JOB - Run Unit Tests
  # ===========================================================================
  test-patient-api:
    name: Test Patient API
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-patient-${{ hashFiles('apps/patient-platform/patient-api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-patient-

      - name: Install dependencies
        working-directory: apps/patient-platform/patient-api
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run tests
        working-directory: apps/patient-platform/patient-api
        env:
          ENVIRONMENT: test
          PYTHONPATH: src
        run: |
          pytest tests/ -v --tb=short -m "not slow" --cov=src --cov-report=xml || true

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: apps/patient-platform/patient-api/coverage.xml
          flags: patient-api
          fail_ci_if_error: false

  test-doctor-api:
    name: Test Doctor API
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-doctor-${{ hashFiles('apps/doctor-platform/doctor-api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-doctor-

      - name: Install dependencies
        working-directory: apps/doctor-platform/doctor-api
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx alembic

      - name: Run tests
        working-directory: apps/doctor-platform/doctor-api
        env:
          ENVIRONMENT: test
          PYTHONPATH: src
        run: |
          pytest tests/ -v --tb=short -m "not slow" --cov=src --cov-report=xml || true

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: apps/doctor-platform/doctor-api/coverage.xml
          flags: doctor-api
          fail_ci_if_error: false

  # ===========================================================================
  # BUILD JOB - Validate Docker Images
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-patient-api, test-doctor-api]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Patient API image
        uses: docker/build-push-action@v5
        with:
          context: apps/patient-platform/patient-api
          file: apps/patient-platform/patient-api/Dockerfile
          push: false
          tags: oncolife-patient-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Doctor API image
        uses: docker/build-push-action@v5
        with:
          context: apps/doctor-platform/doctor-api
          file: apps/doctor-platform/doctor-api/Dockerfile
          push: false
          tags: oncolife-doctor-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Patient Web image
        uses: docker/build-push-action@v5
        with:
          context: apps/patient-platform/patient-web
          file: apps/patient-platform/patient-web/Dockerfile
          push: false
          tags: oncolife-patient-web:${{ github.sha }}
          build-args: |
            VITE_API_BASE_URL=https://api.oncolife.com
            VITE_WS_BASE_URL=wss://api.oncolife.com
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Doctor Web image
        uses: docker/build-push-action@v5
        with:
          context: apps/doctor-platform/doctor-web
          file: apps/doctor-platform/doctor-web/Dockerfile
          push: false
          tags: oncolife-doctor-web:${{ github.sha }}
          build-args: |
            VITE_API_BASE_URL=https://doctor-api.oncolife.com
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # SUMMARY JOB - CI Complete
  # ===========================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ CI passed successfully!"
            exit 0
          else
            echo "❌ CI failed"
            exit 1
          fi

